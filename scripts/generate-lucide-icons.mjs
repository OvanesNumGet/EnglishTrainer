import { promises as fs } from 'node:fs';
import path from 'node:path';

async function exists(p) {
    try {
        await fs.access(p);
        return true;
    } catch {
        return false;
    }
}

async function listFilesRecursive(dir) {
    const out = [];
    const entries = await fs.readdir(dir, { withFileTypes: true });
    for (const e of entries) {
        const p = path.join(dir, e.name);
        if (e.isDirectory()) out.push(...await listFilesRecursive(p));
        else out.push(p);
    }
    return out;
}

function toPascalCaseLucideExport(kebab) {
    // "bar-chart-2" -> "BarChart2"
    // "maximize-2" -> "Maximize2"
    // "party-popper" -> "PartyPopper"
    return kebab
        .split('-')
        .filter(Boolean)
        .map((part) => {
            if (/^\d+$/.test(part)) return part;
            return part.charAt(0).toUpperCase() + part.slice(1);
        })
        .join('');
}

export async function generateLucideIcons({
    outFile = path.join('js', 'lucide-icons.generated.js')
} = {}) {
    const iconNames = new Set();

    const filesToScan = [];
    if (await exists('index.html')) filesToScan.push('index.html');

    if (await exists('html')) {
        const htmlFiles = (await listFilesRecursive('html')).filter((f) => f.endsWith('.html'));
        filesToScan.push(...htmlFiles);
    }

    const re = /data-lucide\s*=\s*["']([^"']+)["']/g;

    for (const file of filesToScan) {
        const content = await fs.readFile(file, 'utf8');
        let m;
        while ((m = re.exec(content)) !== null) {
            const name = (m[1] || '').trim();
            if (name) iconNames.add(name);
        }
    }

    const kebabIcons = Array.from(iconNames).sort((a, b) => a.localeCompare(b));

    // Lucide's createIcons() converts "data-lucide" value to PascalCase internally,
    // so the icons object MUST be keyed by PascalCase names.
    const exportNames = kebabIcons.map(toPascalCaseLucideExport);

    const header = `// AUTO-GENERATED FILE. DO NOT EDIT BY HAND.
// Generated by scripts/generate-lucide-icons.mjs
// Exports only the icons found in data-lucide="..." attributes across your HTML fragments.
// IMPORTANT: Keys are PascalCase because Lucide internally looks up icons by PascalCase.

`;

    let body = '';
    if (kebabIcons.length === 0) {
        body = `export const lucideIcons = {};\n`;
    } else {
        body += `import {\n`;
        body += exportNames.map((n) => `  ${n}`).join(',\n');
        body += `\n} from 'lucide';\n\n`;

        // Object keys are PascalCase identifiers (no quotes)
        body += `export const lucideIcons = {\n`;
        body += exportNames.map((n) => `  ${n}`).join(',\n');
        body += `\n};\n`;
    }

    await fs.mkdir(path.dirname(outFile), { recursive: true });
    await fs.writeFile(outFile, header + body, 'utf8');

    return { iconsCount: kebabIcons.length, outFile };
}

// Allow running directly: node scripts/generate-lucide-icons.mjs
if (import.meta.url === `file://${process.argv[1]}`) {
    generateLucideIcons()
        .then(({ iconsCount, outFile }) => {
            console.log(`Generated ${outFile} (${iconsCount} icons)`);
        })
        .catch((e) => {
            console.error(e);
            process.exitCode = 1;
        });
}
